# í¬íŒ… ë§¤ë‰´ì–¼

> ì•„ë˜ ì„¤ëª…ì€ ëª¨ë‘ EC2 ì„œë²„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë˜ì–´ìˆìŠµë‹ˆë‹¤.

<br><br>

## EC2 ê¸°ë³¸ ì„¤ì •

ì•„ë˜ ê³¼ì •ì€ UFWì´ í™œì„±í™”ë˜ì–´ ìˆë‹¤ëŠ” ì „ì œí•˜ì— ì§„í–‰ë©ë‹ˆë‹¤.

### 80 í¬íŠ¸ í—ˆìš©

1. UFW êµ¬ë™ëœ ìƒíƒœì—ì„œ 80 í¬íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
   ```sh
   sudo ufw allow 80
   ```
2. 80 í¬íŠ¸ê°€ ì •ìƒì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
   ```sh
   sudo ufw status numbered
   ```

<br>

### ì„œë²„ ì‹œê°„ëŒ€ ì„¤ì •

ì¶”í›„ ë””ë²„ê¹…í•  ë•Œ í¸ë¦¬í•˜ë„ë¡ ì„œë²„ ì‹œê°„ëŒ€ë¥¼ í•œêµ­ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

```sh
sudo timedatectl set-timezone Asia/Seoul
```

<br>

### ë¯¸ëŸ¬ ì‚¬ì´íŠ¸ ë³€ê²½

ê° ë¦¬ì „ì— ë§ëŠ” ë¯¸ëŸ¬ì‚¬ì´íŠ¸ë¥¼ ì„¤ì •í•˜ì—¬, ë” ë¹ ë¥´ê³  ì•ˆì •ì ìœ¼ë¡œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ë° ê´€ë¦¬ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•©ë‹ˆë‹¤.

1. APT ì†ŒìŠ¤ ë¦¬ìŠ¤íŠ¸ íŒŒì¼ì„ ì—½ë‹ˆë‹¤.
   ```
   sodu vi /etc/apt/sources.list
   ```
2. ë¯¸ëŸ¬ ì‚¬ì´íŠ¸ë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.
   ```
   :%s/{ê¸°ì¡´ë¯¸ëŸ¬ì„œë²„}/{ë³€ê²½í•  ë¯¸ëŸ¬ì„œë²„}
   ```
   í•œêµ­ì—ì„œëŠ” KAIST ë˜ëŠ” KAKAOë¥¼ ë§ì´ ì‚¬ìš©í•˜ë¯€ë¡œ ì•„ë˜ ë¯¸ëŸ¬ ì‚¬ì´íŠ¸ ì£¼ì†Œë¥¼ ì°¸ê³ í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
   - KAIST: `ftp.kaist.ac.kr`
   - KAKAO: `mirror.kakao.com`

<br>

### ë¦¬ëˆ…ìŠ¤ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜

1. ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì˜ íŒ¨í‚¤ì§€ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•˜ê³ , ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ë¥¼ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œí•©ë‹ˆë‹¤.
   ```sh
   sudo apt update -y
   sudo apt upgrade -y
   ```
   â€» ìƒˆë¡œìš´ íŒ¨í‚¤ì§€ ë²„ì „ì˜ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  ë‚˜ì„œ, í•´ë‹¹ ì •ë³´ë¥¼ í† ëŒ€ë¡œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•´ì•¼ í•˜ë¯€ë¡œ ìœ„ì˜ ëª…ë ¹ì–´ ìˆœì„œë¥¼ ì¤€ìˆ˜í•´ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
2. í•„ìˆ˜ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
   ```sh
   sudo apt-get install -y ca-certificates curl gnupg lsb-release
   ```

<br><br>

## Docker ì„¤ì¹˜ ë° ì„¤ì •

### Docker ì„¤ì¹˜

1. Dockerì˜ ê³µì‹ GPG í‚¤ë¥¼ ì¶”ê°€í•  ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
   ```sh
   sudo mkdir -p /etc/apt/keyrings
   ```
2. Dockerì˜ GPG í‚¤ ë‹¤ìš´ë¡œë“œí•œ í›„, ë°”ì´ë„ˆë¦¬ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.
   ```sh
   curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.png
   ```
3. Docker ì €ì¥ì†Œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
   ```sh
   echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
   ```
4. íŒ¨í‚¤ì§€ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
   ```sh
   sudo apt-get update
   ```
5. Docker íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
   ```sh
   sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
   ```
6. Docker ë°ëª¬ì„ ì‹œì‘í•˜ê³  ë¶€íŒ… ì‹œ ìë™ìœ¼ë¡œ ì‹œì‘í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.
   ```sh
   sudo systemctl start docker
   sudo systemctl enable docker
   ```

<br>

### Docker ì‹¤í–‰ ê¶Œí•œ ì„¤ì •

Docker ì‹¤í–‰ ê¶Œí•œì„ ì„¤ì •í•˜ì—¬, Docker ëª…ë ¹ì„ ì‹¤í–‰í•  ë•Œë§ˆë‹¤ `sudo`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

1. í˜„ì¬ ì‚¬ìš©ìë¥¼ Docker ê·¸ë£¹ì— ì¶”ê°€í•œë‹¤.
   ```sh
   sudo usermode -aG docker $USER
   ```
   - í•´ë‹¹ ë³€ê²½ ì‚¬í•­ì€ ì¦‰ì‹œ ë°˜ì˜ë˜ì§€ ì•Šê³ , ê¸°ë³¸ì ìœ¼ë¡œ ë‹¤ìŒ ë¡œê·¸ì¸ì‹œ ì ìš©ë©ë‹ˆë‹¤.  
      âˆ´ ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí•˜ê³  ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì•¼ ìƒˆë¡œ ì¶”ê°€ëœ ê·¸ë£¹ ê¶Œí•œì´ ì ìš©ë©ë‹ˆë‹¤.  
      ë”°ë¼ì„œ, ë¡œê·¸ì•„ì›ƒ/ë¡œê·¸ì¸ ì—†ì´ ì¦‰ì‹œ ì ìš©í•˜ê³  ì‹¶ë‹¤ë©´, ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ í˜„ì¬ ì„¸ì…˜ì—ì„œ ê·¸ë£¹ ë³€ê²½ ì‚¬í•­ì„ ë°˜ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
     `   netgrp docker`
2. Docker ê·¸ë£¹ì— ì‚¬ìš©ìê°€ ì œëŒ€ë¡œ ì¶”ê°€ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
   ```sh
   groups $USER
   ```

<br>

### Docker Compose ì„¤ì •

1. Docker Compose ë²„ì „ì„ í™•ì¸í•©ë‹ˆë‹¤.
   ```sh
   docker-compose --version
   ```
   ë§Œì•½, `docker-compose` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ë‹¤ë©´ ë‹¤ìŒ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ Docker Composeë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
   ```sh
   sudo curl -L "https://github.com/docker/compose/releases/download/v2.6.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
   sudo chmod +x /usr/local/bin/docker-compose
   sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
   ```

<br><br>

## Nginx ë° certbot ì„¤ì •

### Nginx + certbot Docker Container ì •ì˜

certbotì„ ì´ìš©í•˜ì—¬ ë¬´ë£Œë¡œ SSL/TLS ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ì€ í›„, Nginxì— SSL ì„¤ì •ì„ í•˜ì—¬ HTTPS í†µì‹ ì„ í•˜ë„ë¡ í•©ë‹ˆë‹¤.

1. Nginxì™€ certbot ê´€ë ¨ ì„¤ì • íŒŒì¼ì„ ì €ì¥í•  ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
   ```sh
   mkdir -p ~/dontouch/data/nginx
   mkdir -p ~/dontouch/data/certbot
   ```
2. `~/dontouch/` ë””ë ‰í† ë¦¬ ì•ˆì— Nginxë‘ certbot ì»¨í…Œì´ë„ˆë¥¼ ì •ì˜í•  Docker Composeë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

   ```sh
   cd ~/dontouch
   vi docker-compose .yml
   ```

   <docker-compose.yml>

   ```yml
   version: '3.8'

    services:
        nginx:
            image: nginx:latest
            restart: unless-stopped
            volumes:
                - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf
                - ./data/certbot/conf:/etc/letsencrypt
                - ./data/certbot/www:/var/www/certbot
            ports:
                - "80:80"
                - "443:443"
            command: "/bin/sh -c 'while :; do sleep 320h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
            environment:
                TZ: Asia/Seoul
            logging:
                options:
                    max-size: "10m"
                    max-file: "1"

        certbot:
            image: certbot/certbot
            restart: unless-stopped
            volumes:
                - ./data/certbot/conf:/etc/letsencrypt
                - ./data/certbot/www:/var/www/certbot
            entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 720h & wait $${!}; done;'"
            environment:
                TZ: Asia/Seoul
            logging:
                options:
                    max-size: "10m"
                    max-file: "1"
   ```

<br>

### Nginx ì„¤ì •

1. Nginx ì„¤ì •ì„ ì •ì˜í•©ë‹ˆë‹¤.

   ```sh
   cd ~/dontouch/data/nginx
   vi nginx.conf
   ```

   <nginx.conf>

   ```conf
   user nginx;
   worker_processes 1;

   error_log /var/log/nginx/error.log warn;
   pid /var/run/nginx.pid;

   events {
      worker_connections 1024;
   }

   http {
      include /etc/nginx/mime.types;
      default_type application/octet-stream;

      log_format main '$remote_addr - $remote_user [$time_local] "$request"'
                     '$status $body_bytes_sent "$http_referer"'
                     '"$http_user_agent" "$http_x_forwarded_for"';

      access_log	/var/log/nginx/access.log main;

      sendfile on;
      keepalive_timeout 65;

      limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;

      server {
         listen 80;

         server_name {DOMAIN NAME};
         server_tokens off;

         location /.well-known/acme-challenge/ {
         root /var/www/certbot;
         }

         location / {
               return 308 https://$host$request_uri;
         }
      }


      server {
         listen 443 ssl;

         server_name {DOMAIN NAME};
         server_tokens off;

         ssl_certificate /etc/letsencrypt/live/{DOMAIN NAME}/fullchain.pem;
         ssl_certificate_key /etc/letsencrypt/live/{DOMAIN NAME}/privkey.pem;

         include /etc/letsencrypt/options-ssl-nginx.conf;

         ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

         location / {
               limit_req zone=mylimit burst=1000 nodelay;

               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;

               add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
               add_header Pragma "no-cache";
               add_header Expires "0";

               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization';
               add_header 'Access-Control-Allow-Credentials' 'true';
         }
      }
   }
   ```

### SSL ì¸ì¦ì„œ ë°œê¸‰ ë° ì ìš©

1. SSL ì¸ì¦ì„œë¥¼ ë°œê¸‰í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.

   ```sh
   cd ~/dontouch
   vi init-letsencrypt.sh
   ```

   <init-letsencrypt.sh>

   ```sh
   #!/bin/bash

   # 1. check docker-compose installation
   if ! [ -x "$(command -v docker-compose)" ]; then
      echo 'Error: docker-compose is not installed.' >&2
      exit 1
   fi


   # 2. set domain, RSA key size, data path, email address, test mode
   domains=({DOMAIN NAME})
   rsa_key_size=4096
   data_path="./data/certbot"
   email=""
   staging=0


   # 3. check for existing data and ask the user if they want to overwrite it
   if [ -d "$data_path" ]; then
      read -p "Existing data found for $domains. Continue and replace existing certificate? (y/N)" decision
      if [ "$decision" != "Y" ] && [ "$decision" != "y" ]; then
         exit
      fi
   fi


   # 4. download recommended TSL configuration file
   if [ ! -e "$data_path/conf/options-ssl-nginx.conf" ] || [ ! -e "$data_path/conf/ssl-dhparams.pem" ]; then
      echo "### Downloading recommended TLS parameters ..."

      mkdir -p "$data_path/conf"

      curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf > "$data_path/conf/options-ssl-nginx.conf"
      curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem > "$data_path/conf/ssl-dhparams.pem"

      echo
   fi


   # 5. create temporary dummy certificate
   echo "### Creating dummy certificate for $domains ..."

   path="/etc/letsencrypt/live/$domains"

   mkdir -p "$data_path/conf/live/$domains"

   docker-compose run --rm --entrypoint "\
      openssl req -x509 -nodes -newkey rsa:$rsa_key_size -days 1\
      -keyout '$path/privkey.pem' \
      -out '$path/fullchain.pem' \
      -subj '/CN=localhost'" certbot

   echo


   # 6. start nginx
   echo "### Starting nginx ..."

   docker-compose up --force-recreate -d nginx

   echo


   # 7. delete temporary dummy certificate
   echo "### Deleting dummy certificate for $domains ..."

   docker-compose run --rm --entrypoint "\
      rm -Rf /etc/letsencrypt/live/$domains && \
      rm -Rf /etc/letsencrypt/archive/$domains && \
      rm -Rf /etc/letsencrypt/renewal/$domains.conf" certbot

   echo


   # 8. Request Let's Encrypt certificate
   echo "### Requesting Let's Encrypt certificate for $domains ..."

   # 8-1. set domain arguments
   domain_args=""
   for domain in "${domains[@]}"; do
      domain_args="$domain_args -d $domain"
   done

   # 8-2. set email arguments
   email_arg="--register-unsafely-without-email"
   if [ -n "$email" ]; then
      email_arg="--email $email"
   fi

   # 8-3. set staging arguments
   staging_arg=""
   if [ $staging -ne 0 ]; then
      staging_arg="--staging"
   fi

   docker-compose run --rm --entrypoint "\
      certbot certonly --webroot \
      -w /var/www/certbot \
      $staging_arg \
      $email_arg \
      $domain_args \
      --rsa-key-size $rsa_key_size \
      --agree-tos \
      --force-renewal" certbot

   echo


   # 9. reload nginx
   echo "### Reloading nginx ..."
   docker-compose exec nginx nginx -s reload
   ```

2. ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ì— ì‹¤í–‰ ê¶Œí•œì„ ë¶€ì—¬í•˜ê³  ì‹¤í–‰í•˜ì—¬ SSL ì¸ì¦ì„œë¥¼ ë°œê¸‰ë°›ìŠµë‹ˆë‹¤.
   ```sh
   chmod +x init-letsencrypt.sh
   ./init-letsencrypt.sh
   ```

<br><br>

## WONTOUCH í”„ë¡œì íŠ¸ ë°°í¬

WONTOUCH í”„ë¡œì íŠ¸ëŠ” React 1 + Spring Boot 6 + Redis 3 + MySQL 1 + MongoDB 1ë¡œ ì´ë£¨ì–´ì ¸ ìˆìœ¼ë©°, í•´ë‹¹ í”„ë¡œê·¸ë¨ì„ ëª¨ë‘ ì‹¤í–‰í•´ì•¼ ì •ìƒì ìœ¼ë¡œ ì‘ë™ë©ë‹ˆë‹¤.  
ì•„ë˜ ë‚´ìš©ì€ í•´ë‹¹ git í”„ë¡œì íŠ¸ë¥¼ clone ë°›ì•˜ë‹¤ëŠ” ì „ì œí•˜ì— ì§„í–‰ë©ë‹ˆë‹¤. ğŸ˜‰  
(ì°¸ê³ ë¡œ, `~/wontouch` ë°‘ì— git í”„ë¡œì íŠ¸ë¥¼ clone ë°›ì•˜ë‹¤ ê°€ì •í•˜ê³  ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.)

<br>

**PACKAGE VERSION**  
Package Name | Version
--- | ---
docker | 27.2.1
node.js | 20.16.0
java | openjdk-17.0.11

<br>

**PORT**  
Project Name | Docker Container Name | Port
--- | --- | ---
React | frontend | 3000
Spring Boot for RestAPI | backend-api | 8081
Spring Boot for Authentication | backend-auth | 8082
Spring Boot for Socket Connection | backend-socket | 8083
Spring Boot for Lobby | backend-lobby | 8084
Spring Boot for Game | backend-game | 8085
Spring Boot for Mileage | backend-mileage | 8086
MySQL | mysql | 3306
MongoDB | mongodb | 27017
Redis for Authentication | redis-auth | 6379
Redis for Lobby | redis-lobby | 6379
Redis for Game | redis-game | 6379

<br>

### í™˜ê²½ë³€ìˆ˜ ê´€ë¦¬

1. í”„ë¡œì íŠ¸ì™€ ê´€ë ¨ëœ í™˜ê²½ë³€ìˆ˜ë¥¼ ê´€ë¦¬í•˜ëŠ” íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.

   ```sh
   cd ~/dontouch
   vi .env
   ```

   <.env>

   ```env
   # <BE>
   SERVER_DOMAIN=https://{DOMAIN NAME}

   # server
   API_SERVER_NAME=http://backend-api
   API_SERVER_PORT=8081
   AUTH_SERVER_NAME=http://backend-auth
   AUTH_SERVER_PORT=8082
   SOCKET_SERVER_NAME=http://backend-socket
   SOCKET_SERVER_PORT=8083
   LOBBY_SERVER_NAME=http://backend-lobby
   LOBBY_SERVER_PORT=8084
   GAME_SERVER_NAME=http://backend-game
   GAME_SERVER_PORT=8085
   MILEAGE_SERVER_NAME=http://backend-mileage
   MILEAGE_SERVER_PORT=8086

   #MySQL
   MYSQL_URL=jdbc:mysql://mysql:3306/wontouch
   MYSQL_USERNAME={MYSQL USERNAME}
   MYSQL_PASSWORD={MYSQL PASSWORD}

   # MongoDB
   MONGODB_HOST=mongodb
   MONGODB_PORT=27017
   MONGODB_DATABASE=wontouch
   MONGODB_USERNAME={MONGODB USERNAME}
   MONGODB_PASSWORD={MONGODB PASSWORD}

   # Redis
   REDIS_AUTH_HOST=redis-auth
   REDIS_AUTH_PORT=6379
   REDIS_LOBBY_HOST=redis-lobby
   REDIS_LOBBY_PORT=6379
   REDIS_GAME_HOST=redis-game
   REDIS_GAME_PORT=6379

   # JWT
   SECRET_KEY={JWT SECRET KEY}

   # GOOGLE
   GOOGLE_CLIENT_ID={GOOGLE CLIENT ID}
   GOOGLE_CLIENT_SECRET={GOOGLE CLIENT SECRET}
   GOOGLE_REDIRECT_URI=https://{DOMAIN NAME}/backend-auth/login/oauth2/code/google

   # KAKAO
   KAKAO_CLIENT_ID={KAKAO CLIENT ID}
   KAKAO_CLIENT_SECRET={KAKAO CLIENT SECRET}
   KAKAO_REDIRECT_URI=https://{DOMAIN NAME}/auth/kakao


   # <FE>
   VITE_API_KEY={KAKAO CLIENT ID}
   VITE_SECRET_KEY={KAKAO CLIENT SECRET}
   VITE_REDIRECT_URI=https://{DOMAIN NAME}/auth/kakao
   VITE_API_URL=https://{DOMAIN NAME}/api
   VITE_AUTH_URL=https://{DOMAIN NAME}/api-auth
   VITE_SOCKET_URL=wss://{DOMAIN NAME}/socket
   ```

<br>

### React(Front-End) Docker Image ìƒì„±

1. React í”„ë¡œì íŠ¸ì˜ ìµœìƒìœ„ í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.
   ```sh
   cd ~/dontouch/S11P21B303/frontend
   ```
2. React í”„ë¡œì íŠ¸ë¥¼ npmì„ ì‚¬ìš©í•˜ì—¬ í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•œ í›„ ë¹Œë“œí•©ë‹ˆë‹¤.
   ```sh
   npm install & npm run build
   ```
3. ë¹Œë“œëœ ê²°ê³¼ë¬¼ì„ í† ëŒ€ë¡œ React Docker Imageë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
   ```sh
   docker build -t frontend:latest -f ./Dockerfile .
   ```

<br>

### Spring Boot(Backe-End) Docker Image ìƒì„±

Spring Boot for RestAPI í”„ë¡œì íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ Docker Imageë¥¼ ìƒì„±í•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.  
ë‹¤ë¥¸ Spring Boot í”„ë¡œì íŠ¸ë„ ë™ì¼í•˜ê²Œ ì§„í–‰í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

1. Spring Boot for RestAPI í”„ë¡œì íŠ¸ì˜ ìµœìƒìœ„ í´ë”ë¡œ ì´ë™í•©ë‹ˆë‹¤.
   ```sh
   cd ~/dontouch/S11P21B303/backend/api
   ```
2. Spring Boot í”„ë¡œì íŠ¸ë¥´ gradleì„ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œí•©ë‹ˆë‹¤.
   ```sh
   ./gradlew clean build --no-daemon
   ```
3. ë¹Œë“œëœ ê²°ê³¼ë¬¼ì„ í† ëŒ€ë¡œ Spring Boot for RestAPI Docker Imageë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
   ```sh
   docker build -t backend-api:latest -f ./Dockerfile .
   ```

<br>

### WONTOUCH í”„ë¡œì íŠ¸ Docker Container ìƒì„± ë° ì‹¤í–‰

1. WONTOUCH í”„ë¡œì íŠ¸ì™€ ê´€ë ¨ëœ Docker Containerë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ì„œ ì•ì„œ ìƒì„±í•œ Docker Composeë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.

   ```sh
   cd ~/dontouch
   vi docker-compose.yml
   ```

   <docker-compose.yml>

   ```yml
   version: "3.8"

   services:
     nginx:
       image: nginx:latest
       restart: unless-stopped
       volumes:
         - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf
         - ./data/certbot/conf:/etc/letsencrypt
         - ./data/certbot/www:/var/www/certbot
       ports:
         - "80:80"
         - "443:443"
       command: '/bin/sh -c ''while :; do sleep 320h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''
       environment:
         TZ: Asia/Seoul
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     certbot:
       image: certbot/certbot
       restart: unless-stopped
       volumes:
         - ./data/certbot/conf:/etc/letsencrypt
         - ./data/certbot/www:/var/www/certbot
       entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 720h & wait $${!}; done;'"
       environment:
         TZ: Asia/Seoul
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mysql:
       image: mysql
       restart: unless-stopped
       expose:
         - "3306"
       volumes:
         - ./data/mysql:/var/lib/mysql
       environment:
         TZ: Asia/Seoul
         MYSQL_ROOT_PASSWORD: { MYSQL ROOT PASSWORD }
         MYSQL_DATABASE: wontouch
         MYSQL_USER: ${MYSQL_USERNAME}
         MYSQL_PASSWORD: ${MYSQL_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     mongodb:
       image: mongo
       restart: unless-stopped
       expose:
         - "27017"
       volumes:
         - ./data/mongodb:/data/db
       environment:
         TZ: Asia/Seoul
         MONGO_INITDB_ROOT_USERNAME: { MONGODB ROOT USERNMAE }
         MONGO_INITDB_ROOT_PASSWORD: { MONGODB ROOT PASSWORD }
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     redis-auth:
       image: redis
       restart: unless-stopped
       volumes:
         - ./data/redis/auth:/data
       environment:
         TZ: Asia/Seoul
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     redis-lobby:
       image: redis
       restart: unless-stopped
       volumes:
         - ./data/redis/lobby:/data
       environment:
         TZ: Asia/Seoul
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     redis-game:
       image: redis
       restart: unless-stopped
       volumes:
         - ./data/redis/game:/data
       environment:
         TZ: Asia/Seoul
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-api:
       image: backend-api:latest
       restart: unless-stopped
       expose:
         - ${API_SERVER_PORT}
       environment:
         TZ: Asia/Seoul
         SPRING_PROFILES_ACTIVE: prod
         SERVER_DOMAIN: ${SERVER_DOMAIN}
         # server
         AUTH_SERVER_NAME: ${AUTH_SERVER_NAME}
         AUTH_SERVER_PATH: ${AUTH_SERVER_PORT}/auth
         LOBBY_SERVER_NAME: ${LOBBY_SERVER_NAME}
         LOBBY_SERVER_PATH: ${LOBBY_SERVER_PORT}/lobby
         GAME_SERVER_NAME: ${GAME_SERVER_NAME}
         GAME_SERVER_PATH: ${GAME_SERVER_PORT}/game
         MILEAGE_SERVER_NAME: ${MILEAGE_SERVER_NAME}
         MILEAGE_SERVER_PATH: ${MILEAGE_SERVER_PORT}/mileage
         # MySQL
         MYSQL_URL: ${MYSQL_URL}
         MYSQL_USERNAME: ${MYSQL_USERNAME}
         MYSQL_PASSWORD: ${MYSQL_PASSWORD}
         # MongoDB
         MONGODB_HOST: ${MONGODB_HOST}
         MONGODB_PORT: ${MONGODB_PORT}
         MONGODB_DATABASE: ${MONGODB_DATABASE}
         MONGODB_USERNAME: ${MONGODB_USERNAME}
         MONGODB_PASSWORD: ${MONGODB_PASSWORD}
         # Redis
         REDIS_AUTH_HOST: ${REDIS_AUTH_HOST}
         REDIS_AUTH_PORT: ${REDIS_AUTH_PORT}
         # JWT
         SECRET_KEY: ${SECRET_KEY}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-auth:
       image: backend-auth:latest
       restart: unless-stopped
       expose:
         - ${AUTH_SERVER_PORT}
       environment:
         TZ: Asia/Seoul
         SPRING_PROFILES_ACTIVE: prod
         SERVER_DOMAIN: ${SERVER_DOMAIN}
         # server
         AUTH_SERVER_PORT: ${AUTH_SERVER_PORT}
         # MySQL
         MYSQL_URL: ${MYSQL_URL}
         MYSQL_USERNAME: ${MYSQL_USERNAME}
         MYSQL_PASSWORD: ${MYSQL_PASSWORD}
         # Redis
         REDIS_AUTH_HOST: ${REDIS_AUTH_HOST}
         REDIS_AUTH_PORT: ${REDIS_AUTH_PORT}
         # JWT
         SECRET_KEY: ${SECRET_KEY}
         # GOOGLE
         GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
         GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
         GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI}
         # KAKAO
         KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
         KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
         KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-socket:
       image: backend-socket:latest
       restart: unless-stopped
       expose:
         - ${SOCKET_SERVER_PORT}
       environment:
         TZ: Asia/Seoul
         SPRING_PROFILES_ACTIVE: prod
         # server
         SOCKET_SERVER_PORT: ${SOCKET_SERVER_PORT}
         LOBBY_SERVER_NAME: ${LOBBY_SERVER_NAME}
         LOBBY_SERVER_PATH: ${LOBBY_SERVER_PORT}/lobby
         GAME_SERVER_NAME: ${GAME_SERVER_NAME}
         GAME_SERVER_PATH: ${GAME_SERVER_PORT}/game
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-lobby:
       image: backend-lobby:latest
       restart: unless-stopped
       expose:
         - ${LOBBY_SERVER_PORT}
       environment:
         TZ: Asia/Seoul
         # server
         LOBBY_SERVER_PORT: ${LOBBY_SERVER_PORT}
         SOCKET_SERVER_NAME: ${SOCKET_SERVER_NAME}
         SOCKET_SERVER_PATH: ${SOCKET_SERVER_PORT}/socket
         # Redis
         REDIS_LOBBY_HOST: ${REDIS_LOBBY_HOST}
         REDIS_LOBBY_PORT: ${REDIS_LOBBY_PORT}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-game:
       image: backend-game:latest
       restart: unless-stopped
       expose:
         - ${GAME_SERVER_PORT}
       environment:
         TZ: Asia/Seoul
         # server
         GAME_SERVER_PORT: ${GAME_SERVER_PORT}
         SOCKET_SERVER_NAME: ${SOCKET_SERVER_NAME}
         SOCKET_SERVER_PATH: ${SOCKET_SERVER_PORT}/socket
         MILEAGE_SERVER_NAME: ${MILEAGE_SERVER_NAME}
         MILEAGE_SERVER_PATH: ${MILEAGE_SERVER_PORT}/mileage
         # MongoDB
         MONGODB_HOST: ${MONGODB_HOST}
         MONGODB_PORT: ${MONGODB_PORT}
         MONGODB_DATABASE: ${MONGODB_DATABASE}
         MONGODB_USERNAME: ${MONGODB_USERNAME}
         MONGODB_PASSWORD: ${MONGODB_PASSWORD}
         # Redis
         REDIS_GAME_HOST: ${REDIS_GAME_HOST}
         REDIS_GAME_PORT: ${REDIS_GAME_PORT}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     backend-mileage:
       image: backend-mileage:latest
       restart: unless-stopped
       expose:
         - ${MILEAGE_SERVER_PORT}
       environment:
         TZ: Asia/Seoul
         # server
         MILEAGE_SERVER_PORT: ${MILEAGE_SERVER_PORT}
         API_SERVER_NAME: ${API_SERVER_NAME}
         API_SERVER_PATH: ${API_SERVER_PORT}/api
         # MySQL
         MYSQL_URL: ${MYSQL_URL}
         MYSQL_USERNAME: ${MYSQL_USERNAME}
         MYSQL_PASSWORD: ${MYSQL_PASSWORD}
         # MongoDB
         MONGODB_HOST: ${MONGODB_HOST}
         MONGODB_PORT: ${MONGODB_PORT}
         MONGODB_DATABASE: ${MONGODB_DATABASE}
         MONGODB_USERNAME: ${MONGODB_USERNAME}
         MONGODB_PASSWORD: ${MONGODB_PASSWORD}
       logging:
         options:
           max-size: "10m"
           max-file: "1"

     frontend:
       image: frontend:latest
       restart: unless-stopped
       expose:
         - "3000"
       environment:
         TZ: Asia/Seoul
         NODE_ENV: production
         VITE_API_KEY: ${VITE_API_KEY}
         VITE_SECRET_KEY: ${VITE_SECRET_KEY}
         VITE_REDIRECT_URI: ${VITE_REDIRECT_URI}
         VITE_AUTH_URL: ${VITE_AUTH_URL}
         VITE_API_URL: ${VITE_API_URL}
         VITE_SOCKET_URL: ${VITE_SOCKET_URL}
       logging:
         options:
           max-size: "10m"
           max-file: "1"
   ```

2. React ë° publicìœ¼ë¡œ ì‹¤í–‰í•  Spring Bootì— ëŒ€í•´ì„œ Nginxì—ì„œ ì„¤ì •í•´ì¤ë‹ˆë‹¤.

   ```sh
   cd ~/dontouch/data/nginx
   vi nginx.conf
   ```

   <nginx.conf>

   ```conf
   user nginx;
   worker_processes 1;

   error_log /var/log/nginx/error.log warn;
   pid /var/run/nginx.pid;

   events {
      worker_connections 1024;
   }

   http {
      include /etc/nginx/mime.types;
      default_type application/octet-stream;

      log_format main '$remote_addr - $remote_user [$time_local] "$request"'
                     '$status $body_bytes_sent "$http_referer"'
                     '"$http_user_agent" "$http_x_forwarded_for"';

      access_log	/var/log/nginx/access.log main;

      sendfile on;
      keepalive_timeout 65;

      limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;

      upstream backend-api {
         server backend-api:8081;
      }

      upstream backend-auth {
         server backend-auth:8082;
      }

      upstream backend-socket {
         server backend-socket:8083;
      }

      server {
         listen 80;

         server_name {DOMAIN NAME};
         server_tokens off;

         location /.well-known/acme-challenge/ {
         root /var/www/certbot;
         }

         location / {
               return 308 https://$host$request_uri;
         }
      }


      server {
         listen 443 ssl;

         server_name {DOMAIN NAME};
         server_tokens off;

         ssl_certificate /etc/letsencrypt/live/{DOMAIN NAME}/fullchain.pem;
         ssl_certificate_key /etc/letsencrypt/live/{DOMAIN NAME}/privkey.pem;

         include /etc/letsencrypt/options-ssl-nginx.conf;

         ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

         location / {
               limit_req zone=mylimit burst=1000 nodelay;

               proxy_pass http://frontend:3000;

               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;

               add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
               add_header Pragma "no-cache";
               add_header Expires "0";

               add_header 'Access-Control-Allow-Origin' '*';
               add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
               add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization';
               add_header 'Access-Control-Allow-Credentials' 'true';
         }

         location /api {
               proxy_pass http://backend-api/api;

               proxy_http_version 1.1;

               proxy_set_header Connection '';
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;
               proxy_set_header X-Forwarded-Port 443;

               proxy_buffering off;
               proxy_read_timeout 3600;
               proxy_send_timeout 3600;
               chunked_transfer_encoding off;
         }

         location /api-auth {
               proxy_pass http://backend-auth/auth;

               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;
               proxy_set_header X-Forwarded-Port 443;
         }

         location /socket {
               proxy_pass http://backend-socket/socket;

               proxy_http_version 1.1;

               proxy_set_header Upgrade $http_upgrade;
               proxy_set_header Connection "Upgrade";
               proxy_set_header Host $host;
               proxy_set_header X-Real-IP $remote_addr;
               proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
               proxy_set_header X-Forwarded-Proto $scheme;
               proxy_set_header X-Forwarded-Port 443;

               proxy_read_timeout 3600;
               proxy_send_timeout 3600;
               proxy_connect_timeout 3600;
         }
      }
   }
   ```

3. MongoDB Docker Containerë¥¼ ì‹¤í–‰í•œ í›„, wontouchì—ë§Œ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

   ```sh
   # MongoDB Docker Container ìƒì„± ë° ì‹¤í–‰
   docker-compose up -d mongodb

   # MongoDB shell ì‹¤í–‰
   docker-compose exec -it mongodb mongosh -u root -p

   # MongoDB user ìƒì„±
   test> use wontouch
   wontouch> db.createUser({user: "{MONGODB USERNAME}", pwd: "{MONGODB PASSWORD}" roles: ["readWrite"]})

   # user ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
   wontouch> db.getUsers()

   wontouch> exit
   ```

4. **wontouch.crop.json** íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ MongoDBì— wontouch database ì•ˆì— ì‘ë¬¼ ê´€ë ¨ ê¸°ì‚¬ ì •ë³´ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
5. MySQL Docker Containerë¥¼ ìƒì„± ë° ì‹¤í–‰í•©ë‹ˆë‹¤.  
   (Spring Boot for RestAPI/Authenticationì˜ JPAë¥¼ í†µí•´ì„œ MySQLì˜ í…Œì´ë¸”ì„ ìƒì„±í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.)
   ```sh
   docker-compose up -d mysql
   ```
6. ê·¸ ì™¸ ë‚˜ë¨¸ì§€ Docker Containerë¥¼ ìƒì„± ë° ì‹¤í–‰í•©ë‹ˆë‹¤.
   ```sh
   docker-compose up -d nginx certbot frontend backend-api backend-auth backend-socket backend-lobby backend-game backend-mileage redis-auth redis-lobby redis-game
   ```
